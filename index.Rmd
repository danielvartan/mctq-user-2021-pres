---
title: "{mctq}: <br> An R Package for the Munich ChronoType Questionnaire"
author: "Daniel Vartanian"
date: "July 2021"
encoding: "UTF-8"
output:
  xaringan::moon_reader:
    chakra: "libs/remark-latest.min.js"
    css: ["useR", "useR-fonts", "css/custom.css"]
    lib_dir: "libs"
    includes:
      in_header: header.html
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
```

```{r, xaringanExtra, include = FALSE}
## Learn more at https://pkg.garrickadenbuie.com/xaringanExtra/#/

# xaringanExtra::use_animate_css()
# xaringanExtra::use_broadcast()
xaringanExtra::use_clipboard()
# xaringanExtra::use_editable(expires = 1)
xaringanExtra::use_extra_styles(hover_code_line = TRUE)
# xaringanExtra::use_fit_screen()
# xaringanExtra::use_freezeframe(responsive = FALSE)
# xaringanExtra::use_logo(image_url = "img/logo.png")
# xaringanExtra::use_panelset()
# xaringanExtra::use_scribble()
# xaringanExtra::use_search(show_icon = TRUE)
# xaringanExtra::use_share_again()
# xaringanExtra::use_slide_tone()
# xaringanExtra::use_tachyons()
xaringanExtra::use_tile_view()
xaringanExtra::use_webcam()
```

```{r, metathis, include = FALSE}
library(metathis)
meta() %>%
  meta_general(
    description = "An introduction to the {mctq} package.",
    generator = "xaringan and remark.js") %>% 
  meta_name("github-repo" = "gipsousp/mctq.user2021") %>% 
  meta_social(
    title = "{mctq}: An R Package for the Munich ChronoType Questionnaire",
    url = "https://gipsousp.github.io/mctq.user2021",
    image = "https://gipsousp.github.io/mctq.user2021/cover.png",
    image_alt = "The first slide of the Introduction to the {mctq} Package presentation",
    og_type = "website",
    og_author = "Daniel Vartanian",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@danielvartan"
  )
```


## Overview

.pull-left[
`mctq` is an R package that provides a complete and consistent toolkit to process the Munich ChronoType Questionnaire (MCTQ), a quantitative and validated method to assess peoplesâ€™ sleep behavior presented by Till Roenneberg, Anna Wirz-Justice, and Martha Merrow in [2003](https://doi.org/10.1177/0748730402239679).

The aim of `mctq` is to facilitate the work of sleep and chronobiology scientists with MCTQ data while also helping with research reproducibility.
]

.pull-right[
```{r, echo = FALSE, fig.align = "center", out.width = "50%"}
knitr::include_graphics("img/logo.png")
```

Code repository: [https://github.com/gipsousp/mctq](https://github.com/gipsousp/mctq)

Documentation website: [https://gipsousp.github.io/mctq](https://gipsousp.github.io/mctq)
]

???

00:00 -> 00:30

---

## Authors

.custom_1[
__[Daniel Vartanian](https://github.com/danielvartan)__. Author, maintainer, copyright holder. [`r fontawesome::fa("orcid", fill = "#A6CE39")`](https://orcid.org/0000-0001-7782-759X)

__[Ana Amelia Benedito-Silva](https://github.com/AnaAmeliaBeneditoSIlva)__. Author, scientific advisor. [`r fontawesome::fa("orcid", fill = "#A6CE39")`](https://orcid.org/0000-0003-4976-2623)

__[Mario Pedrazzoli](https://github.com/pedrazzo)__. Author, scientific advisor. [`r fontawesome::fa("orcid", fill = "#A6CE39")`](https://orcid.org/0000-0002-5257-591X)

__[Jonathan Keane](https://github.com/jonkeane)__. Reviewer. [`r fontawesome::fa("orcid", fill = "#A6CE39")`](https://orcid.org/0000-0001-7087-9776)

__[Mario Andre Leocadio-Miguel](https://github.com/leocadio-miguel)__. Reviewer. [`r fontawesome::fa("orcid", fill = "#A6CE39")`](https://orcid.org/0000-0002-7248-3529)

__[Interdisciplinary Sleep Research Group (GIPSO)](http://each.usp.br/gipso)__. Funder.

__[University of Sao Paulo(USP)](http://usp.br/)__. Funder.
]

---

class: chapter-slide

# What is MCTQ?

???

00:31 -> 01:30

---

## A (very) brief history of time and life

.pull-left[
```{r, echo = FALSE, out.width = "100%", fig.align = "center"}
knitr::include_graphics("https://media.giphy.com/media/l1J9RYDHqVp5phcYw/giphy.gif")
```
]

.pull-right[
```{r, echo = FALSE, out.width = "100%", fig.align = "center"}
knitr::include_graphics("https://media.giphy.com/media/JDENkPiyQoCFW/giphy.gif")
```
]

---

## Chronotypes: temporal phenotypes

See also: Roenneberg, Pilz, Zerbini, & Winnebeck ([2019](https://doi.org/10.3390/biology8030054)).

```{r, echo = FALSE, out.width = "50%", fig.align = "center"}
knitr::include_graphics("https://media.giphy.com/media/3o7aD0v27NBhhOfdXW/giphy.gif")
```

---

## Morning-Evening spectrum

```{r, echo = FALSE, fig.align = 'center', fig.width = 10, fig.height = 6, message = FALSE}
library(dplyr)
library(ggplot2)
library(hms)
library(lubridate)
library(mctq)
library(scales)

mean <- hms::parse_hm("05:02")
sd <- hms::parse_hm("01:32")
i <- 1000
set.seed(20)

labels_ <- function(x, jump_even = TRUE, jump_odd = FALSE, jump_one = FALSE) {
    breaks <- x %>%
        lubridate::as_datetime() %>%
        hms::as_hms() %>%
        substr(1, 5)

    if (isTRUE(jump_even)) breaks[seq_along(breaks) %% 2 == 0] <- ""
    if (isTRUE(jump_odd)) breaks[!seq_along(breaks) %% 2 == 0] <- ""
    if (isTRUE(jump_one)) breaks[seq_along(breaks) %% 3 == 0] <- ""

    breaks
}

classify <- function(x) {
    x <- as.numeric(x)
    quantiles <- stats::quantile(x, seq(from = 0, to = 1, by = 1 / 3))

    factor(cut(x, quantiles, labels = FALSE, include.lowest = TRUE),
           labels = c("Morning type",
                      "Intermediary",
                      "Evening type"))
}

dplyr::tibble(msf_sc = hms::hms(rnorm(i, mean, sd))) %>%
    dplyr::mutate(msf_sc = mctq:::midday_change(msf_sc)) %>%
    dplyr::mutate(msf_sc = as.numeric(msf_sc)) %>%
    ggplot2::ggplot(aes(msf_sc, fill = classify(msf_sc))) +
    ggplot2::geom_bar() +
    ggplot2::scale_x_binned(n.breaks = 15,
                            labels = labels_) +
    ggplot2::labs(x = "Corrected mid-sleep ('msf_sc')",
                  y = "",
                  fill = "Chronotype") +
    scale_fill_viridis_d() +
  ggplot2::theme(axis.title = element_text(size = 20),
                 axis.text = element_text(size = 20),
                 legend.title = element_text(size = 20),
                 legend.text = element_text(size = 20))

```

---

background-image: url("img/article_1.png")
background-position: center
background-size: contain

---

background-image: url("img/article_2.png")
background-position: center
background-size: contain

---

background-image: url("img/article_3.png")
background-position: center
background-size: contain

---

background-image: url("img/thewep_mctq-core_1.png")
background-position: center
background-size: contain

---

background-image: url("img/thewep_mctq-core_2.png")
background-position: center
background-size: contain

---

class: chapter-slide

# The problem(s)

???

01:31 -> 02:30

---

## Main challenges

* MCTQ requires a lot of date/time manipulation
* MCTQ deals with temporal objects detached from a timeline
* Lack of consistency in computations
* Inconsistencies can lead to irreproducible results

---

## Temporal objects

.pull-left[
Temporal objects demand more abstraction levels.

* Time is not metrical
* Time is cyclical
* Time is relational (itself does not exist)

Cool stuff: [Why Don't We Have Metric Time? | Answers With Joe](https://youtu.be/kUIYI34CdkE).
]

.pull-right[
```{r, echo = FALSE, out.width = "100%", fig.align = "center"}
knitr::include_graphics("https://media.giphy.com/media/3o6MbjnP31zfxSI2Zi/giphy.gif")
```
]

???

* Duodecimal (base 12) and sexagesimal (base 60) systems.
* Time frames (e.g., 24, 12, 60)

---

class: chapter-slide

# The {mctq} package

???

02:31 -> 04:30

---

## Installation

``` {r, eval = FALSE}
# install.packages("pak")
pak::pkg_install("gipsousp/mctq")
```

```{r, message = FALSE}
library(mctq)
```


---

## Conversion

`mctq` works with a set of object classes specially created to hold time values. These classes can be found in the [lubridate](https://lubridate.tidyverse.org/) and [hms](https://hms.tidyverse.org/) packages from [tidyverse](https://www.tidyverse.org/packages/). If your data do not conform to the object classes required, you can use `mctq` `convert()` function to convert it.

```{r, message = FALSE}
# From decimal hours to `hms`
convert(6.5, "hms", input_unit = "H")
# From radians to `Duration`
convert(1.308997, "Duration", input_unit = "rad")
# From `character` `HM AM/PM ` to `hms`
convert("10:00 PM", "hms", orders = "IMp")
```

---

## Workdays and work-free days variables

After your data is set to start, just use the `mctq` functions below to process it.

Note that the `mctq` functions uses a similar naming scheme to that used in the MCTQ publications. That makes it easy to find and apply any computation necessary.

* `fd()`: compute MCTQ work-free days
* `so()`: compute MCTQ local time of sleep onset
* `gu()`: compute MCTQ local time of getting out of bed
* `sd()`: compute MCTQ sleep duration
* `tbt()`: compute MCTQ total time in bed
* `ms()`: compute MCTQ local time of mid-sleep
* `napd()`: compute MCTQ nap duration (only for MCTQ Shift)
* `sd24()`: compute MCTQ 24 hours sleep duration (only for MCTQ Shift)

---

## Workdays and work-free days variables

Example:

```{r, message = FALSE}
# Local time of preparing to sleep on workdays
sprep_w <- c(hms::parse_hms("23:45:00"), hms::parse_hms("02:15:00"))
# Sleep latency or time to fall asleep after preparing to sleep on workdays
slat_w <- c(lubridate::dminutes(30), lubridate::dminutes(90))
# Local time of sleep onset on workdays
so(sprep_w, slat_w)
```

---

## Combining workdays and work-free days variables

For computations combining workdays and work-free days, use:

* `sd_week()`: compute MCTQ average weekly sleep duration
* `sd_overall()`: compute MCTQ overall sleep duration (only for MCTQ Shift)
* `sloss_week()`: compute MCTQ weekly sleep loss
* `le_week()`: compute MCTQ average weekly light exposure
* `msf_sc()`: compute MCTQ chronotype or corrected local time of mid-sleep on work-free days
* `sjl_rel()` and `sjl()`: compute MCTQ social jet lag
* `sjl_weighted()`: compute MCTQ absolute social jetlag across all shifts (only for MCTQ Shift)

---

## Combining workdays and work-free days variables

Example:

```{r, message = FALSE}
# Local time of mid-sleep on workdays
msw <- c(hms::parse_hms("02:05:00"), hms::parse_hms("04:05:00"))
# Local time of mid-sleep on work-free days
msf <- c(hms::parse_hms("23:05:00"), hms::parse_hms("08:30:00"))
# Relative social jetlag
sjl_rel(msw, msf)
```

See a quick tour of all MCTQ main functions at https://gipsousp.github.io/mctq/articles/mctq.html.

---

## Utilities

In addition to `convert()`, `mctq` is also equipped with many other utility functions.

```{r}
random_mctq(model = "standard") %>% head(5)
```

---

## Data

The package also provides __fictional__ datasets of the standard, micro, and shift MCTQ versions __for testing and learning purposes__.

```{r, echo = FALSE, out.width = "100%", out.height = "100%"}
library(DT)
library(mctq)
DT::datatable(mctq::pretty_mctq(mctq::micro_mctq), 
              extensions = "KeyTable",
              filter = "none",
              options = list(dom = "tp",
                             pageLength = 6,
                             scrollX = TRUE))
```

---

## Documentation

`mctq` is fully documented. Learn more in [gipsousp.github.io/mctq](gipsousp.github.io/mctq).

```{r, echo = FALSE}
knitr::include_url("https://gipsousp.github.io/mctq/reference/msf_sc.html")
```

---

class: chapter-slide

# Final remarks

???

04:31 -> 05:00

---

## Notes

* `mctq` is [maturing](https://lifecycle.r-lib.org/articles/stages.html)
* `mctq` is currently under a [rOpenSci peer review](https://github.com/ropensci/software-review/issues/434)
* `mctq` will be submitted to CRAN soon
* We plan to invite the MCTQ authors to review and author the package
* An article about `mctq` will be published soon

---

class: chapter-slide

# Thank you!
